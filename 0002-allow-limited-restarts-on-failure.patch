From bb3f7b5b254c76c323e5ce31e702e49f4d90c451 Mon Sep 17 00:00:00 2001
From: Jose Lamego <jose.a.lamego@intel.com>
Date: Thu, 27 Sep 2018 17:46:51 -0500
Subject: [PATCH] crio.service: allow limited restarts on failure

crio.service may fail to start if network is not fully available.

This change allows crio.service to restart on failure up to 6 times
with a 10 second delay between each attempt, during periods of 2
minutes -following same approach as the one for kubelet.service-
and being applied on top of the previous commit that updated the
ExecStart line to appropriate crio bin path.

Fixes: clearlinux/distribution#192

Signed-off-by: Jose Lamego <jose.a.lamego@intel.com>
---
 contrib/systemd/crio.service | 7 +++++--
 1 file changed, 5 insertions(+), 2 deletions(-)

diff --git a/contrib/systemd/crio.service b/contrib/systemd/crio.service
index 80b7578..07c9b37 100644
--- a/contrib/systemd/crio.service
+++ b/contrib/systemd/crio.service
@@ -2,12 +2,14 @@
 Description=Open Container Initiative Daemon
 Documentation=https://github.com/kubernetes-sigs/cri-o
 After=network-online.target
+StartLimitIntervalSec=120
+StartLimitBurst=6
 
 [Service]
 Type=notify
 EnvironmentFile=-/etc/sysconfig/crio
 Environment=GOTRACEBACK=crash
-ExecStart=/usr/local/bin/crio \
+ExecStart=/usr/bin/crio \
           $CRIO_STORAGE_OPTIONS \
           $CRIO_NETWORK_OPTIONS \
           $CRIO_METRICS_OPTIONS
@@ -18,7 +20,8 @@ LimitNPROC=1048576
 LimitCORE=infinity
 OOMScoreAdjust=-999
 TimeoutStartSec=0
-Restart=on-abnormal
+Restart=on-failure
+RestartSec=10
 
 [Install]
 WantedBy=multi-user.target
-- 
2.20.0

